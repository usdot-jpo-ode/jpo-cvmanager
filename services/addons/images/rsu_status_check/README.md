# RSU Status Fetch services

## Table of Contents

- [RSU Status Fetch services](#rsu-status-fetch-services)
  - [Table of Contents](#table-of-contents)
  - [About ](#about)
  - [Cron Jobs](#cron-jobs)
  - [Requirements ](#requirements)
    - [rsu_ping_fetch](#rsu_ping_fetch)
    - [rsu_pinger](#rsu_pinger)
    - [rsu_msgfwd_fetch](#rsu_msgfwd_fetch)

## About <a name = "about"></a>

This directory contains three services that run within the CV Manager GKE Cluster as a single microservice called the 'rsu_status_check'.

Both the 'rsu_ping_fetch' and 'rsu_pinger' services populate the CV Manager PostGreSQL database's 'ping' table with the current online statuses of all RSUs recorded in the 'rsus' table. For 'rsu_ping_fetch', these statuses are retrieved directly from a [Zabbix server](https://www.zabbix.com/). For 'rsu_pinger', these statuses are generated by pinging every RSU in the 'rsus' table every 1 minute.

If you have access to a Zabbix server that is tracking RSUs, it is recommended to use the 'rsu_ping_fetch' service. However, the 'rsu_pinger' is an effective alternative.

Another feature the 'rsu_status_check' application provides is a ping data purger that will remove stale ping data from the CV Manager PostgreSQL database to allow for high performance RSU ping queries. The amount of time a message needs to be in the database to be considered stale is configurable with the STALE_PERIOD environment variable. This purger will run once every 24 hours to check for stale ping data in the database.

The 'rsu_msgfwd_fetch' service is used to monitor the current state of deployed RSUs' SNMP message forwarding configurations. This information is stored in PostgreSQL to allow for the CV Manager to have a historic record of the last configuration a RSU was known to have. This helps with offline RSUs and to allow a consistent performance behavior for users instead of waiting on a SNMPwalk to return. This data is monitored every 4 hours. Configurations are added, removed or left intact in the PostgreSQL database based on the results of the SNMPwalks performed by the 'rsu_msgfwd_fetch' service.

## Cron Jobs <a name = "cron-job-configurations"></a>

The RSU Status Fetch services are configured to automatically run at predefined intervals through cron jobs. Here is a list of the various jobs with their default runtime and frequencies. This can be customized by altering the [crontab](./crontab) file.

RSU Online Status Jobs

- rsu_ping_fetch - Every minute, on the minute
- rsu_pinger - Every minute, on the minute
- purger - Every day, at midnight (UTC)

RSU SNMP Status Jobs

- rsu_msgfwd_fetch - Every 4 hours, on the hour
- rsu_security_fetch - Every hour, on the hour
- rsu_health_fetch - Every 20 minutes, on the minute

## Requirements <a name = "requirements"></a>

### rsu_ping_fetch

To properly run the rsu_ping_fetch service the following additional services are also required:

- CV Manager PostgreSQL database with at least one RSU inserted into the 'rsus' table
- Zabbix server with the REST API enabled
- rsu_status_check must be deployed in the same environment or K8s cluster as the PostgreSQL database
- Network rules must be in place to allow proper routing between the rsu_status_check microservice and the Zabbix server

The rsu_ping_fetch service expects the following environment variables to be set:

- RSU_PING = True
- ZABBIX = True
- ZABBIX_ENDPOINT - Zabbix API access endpoint.
- ZABBIX_USER - Zabbix API access username.
- ZABBIX_PASSWORD - Zabbix API access password.
- DB_USER - PostgreSQL access username.
- DB_PASS - PostgreSQL access password.
- DB_NAME - PostgreSQL database name.
- DB_HOST - PostgreSQL hostname, make sure to include port number.
- STALE_PERIOD - Number of hours a ping log needs to be around in the PostgreSQL database to be considered stale.
- RSU_MSGFWD_FETCH - Feature flag for collecting active message forwarding configurations from all RSUs in the PostgreSQL database. Supports both NTCIP-1218 and RSU 4.1 supported devices.
- RSU_SECURITY_FETCH - Feature flag for collecting SCMS certificate expiration and health data from all RSUs in the PostgreSQL database. Supports only NTCIP-1218 supported devices.
- RSU_HEALTH_FETCH - Feature flag for collecting the RSU health status from all RSUs in the PostgreSQL database. Supports only NTCIP-1218 supported devices.
- LOGGING_LEVEL (optional, defaults to 'info')

### rsu_pinger

To properly run the rsu_pinger service the following additional services are also required:

- CV Manager PostgreSQL database with at least one RSU inserted into the 'rsus' table
- rsu_status_check must be deployed in the same environment or K8s cluster as the PostgreSQL database
- Network rules must be in place to allow proper routing between the rsu_status_check microservice and deployed RSUs

The rsu_pinger service expects the following environment variables to be set:

- RSU_PING = True
- ZABBIX = False
- DB_USER - PostgreSQL access username.
- DB_PASS - PostgreSQL access password.
- DB_NAME - PostgreSQL database name.
- DB_HOST - PostgreSQL hostname, make sure to include port number.
- STALE_PERIOD - Number of hours a ping log needs to be around in the PostgreSQL database to be considered stale.
- LOGGING_LEVEL (optional, defaults to 'info')

### rsu_msgfwd_fetch

To properly run the rsu_msgfwd_fetch service the following additional services are also required:

- CV Manager PostgreSQL database with at least one RSU inserted into the 'rsus' table
- rsu_status_check must be deployed in the same environment or K8s cluster as the PostgreSQL database
- Network rules must be in place to allow proper routing between the rsu_status_check microservice and deployed RSUs

The rsu_msgfwd_fetch service expects the following environment variables to be set:

- RSU_MSGFWD_FETCH = True
- DB_USER - PostgreSQL access username.
- DB_PASS - PostgreSQL access password.
- DB_NAME - PostgreSQL database name.
- DB_HOST - PostgreSQL hostname, make sure to include port number.
- STALE_PERIOD - Number of hours a ping log needs to be around in the PostgreSQL database to be considered stale.
- RSU_MSGFWD_FETCH - Feature flag for collecting active message forwarding configurations from all RSUs in the PostgreSQL database. Supports both NTCIP-1218 and RSU 4.1 supported devices.
- LOGGING_LEVEL (optional, defaults to 'info')
