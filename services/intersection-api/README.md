# CVManager Intersection API

The intersection api enables the CV Manager webapp to view/retrieve live & historic intersection data, modify intersection monitoring parameters, and view generated reports. The data backing this API is generated by the [jpo-conflictmonitor](https://github.com/usdot-jpo-ode/jpo-conflictmonitor), which uses finely tuned algorithms to analyze MAP, SPaT, and BSM messages to generate events, assessments, and notifications. Below is a brief overview of these concepts, for a complete description and definitions please see [CIMMS_Software_Design.pdf](./docs/CIMMS_Software_Design.pdf):

- Events: individual occurrences of an action, not necessarily offending. Some examples of events are:
  - BSMs of a vehicle driving normally across an intersection
  - BSMs of a vehicle stopping at a traffic light
  - MAP messages not published frequently enough
  - SPaT time change details minimum change time decreases
- Assessments: Aggregations of events
- Notifications: Events or assessments which surpass configured thresholds

All of the data flowing into and out of the intersection api is shown in the following dataflow diagram:
![Intersection Api Dataflow Diagram](./docs/Intersection_Api_Dataflows.png)

To view the endpoint configuration of the api, open the following HTML page in a browser: [docs/swagger-docs/docs.html](./docs/swagger-docs/docs.html)

## Framework

This is a Java SpringBoot application, utilizing REST and STOMP protocols. This application is fully dockerized and is designed to run alongside an instance of the [jpo-ode](https://github.com/usdot-jpo-ode/jpo-ode), [jpo-geojsonconverter](https://github.com/usdot-jpo-ode/jpo-geojsonconverter), [jpo-conflictmonitor](https://github.com/usdot-jpo-ode/jpo-conflictmonitor). This project imports pre-built images for these services from (DockerHub)[https://hub.docker.com/u/usdotjpoode]. If you would like to build them locally, information is available in their respective repositories.

The cvmanager intersection-api is built off of the [conflictvisualizer api](https://github.com/usdot-jpo-ode/jpo-conflictvisualizer/tree/cvmgr-cimms-integration/api). This directory contains that customized api.

## Contents

- /api: Intersection API application
- /asn1_codec: Submodule of [asn1_codec](https://github.com/usdot-jpo-ode/asn1_codec) repo
  - Used to decode ASN.1 into MAP, SPaT, and BSM messages

## Installation

### 1. Initialize and update submodules

Initialize all submodules in the repository:

```
git submodule update --init --recursive
```

### 2. Run Required Docker Resources

Docker compose profiles allow customization of which features to run. In this case, we want to run all of the basic, intersection, and conflictmonitor services, excluding the intersection api. This can be done like so:

CD into the root project directory

```sh
cd ../../
```

Ensure your COMPOSE_PROFILES env var (in root .env) is set to: "basic,intersection_no_api,conflictmonitor"

Run all docker images

```sh
docker compose up -d
```

### 3. Setup Environment Variables

Make sure to set the JPO ConflictMonitor and cvmanager intersection api environment variables in the root .env file (from sample.env)

- Optional - Modify application.properties and application.yaml files in ./api/src/main/resources/ and configure them for deployment. Most features are controlled by environment variables, but some features may require additional configuration.

#### Github Token

A GitHub token is required to pull required java artifacts from GitHub repositories. This is required to obtain the jpo-ode jars and must be done before attempting to build this repository.

1. Log into GitHub.
2. Navigate to Settings -> Developer settings -> Personal access tokens.
3. Click "New personal access token (classic)".
   1. As of now, GitHub does not support Fine-grained tokens for obtaining packages.
4. Provide a recognizable name
5. Set an expiration date
6. Select the read:packages scope.
7. Click "Generate token" and copy the token.
8. Set this token as the MAVEN_GITHUB_TOKEN environment variable in the .env file (root and ./services/intersection-api/.env)

### 4. Start Intersection API

To run the intersection API, after all of the other services have been run,

```sh
docker compose up --build -d intersection_api
```

## Development Environments

The below section provides additional instruction on how to setup the intersection api for development. This section describes how to run the components locally to allow for quick changes and rapid iteration.

### 1. Running Intersection API Locally

See the [api/README.md](api/README.md#running-locally) for instructions

### 2. Running Smtp4dev

An Smtp4dev server can be used locally to test the Email capabilities of the conflict monitor API: [smtp4dev](https://github.com/rnwood/smtp4dev). Once running, this server can be connected to the api (and Keycloak).