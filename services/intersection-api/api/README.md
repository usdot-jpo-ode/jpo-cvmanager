# Intersection Api

The Intersection API enables users to see events and assessments generated by the conflict monitor application.
For more information on this api, see the parent [README.md](../README.md)

## Setup

(Optional) Fill in any additional data in the [application.properties](application.properties) file before running the API to ensure proper operation.

## Running Locally

The intersection API requires the following dependencies be installed to run locally

- Java 22 (JAVA_HOME)
- Maven
- Docker **(Just for unit tests, Engine must be running)**

### Github Token

A GitHub token is required to pull dependent java artifacts from GitHub repositories. This is necessary to obtain the jpo-ode jars and must be done before attempting to build this project.

1. Log into GitHub.
2. Navigate to Settings -> Developer settings -> Personal access tokens.
3. Click "New personal access token (classic)".
   1. As of now, GitHub does not support Fine-grained tokens for obtaining packages.
4. Provide a recognizable name
5. Set an expiration date
6. Select the read:packages scope.
7. Click "Generate token" and copy the token.
8. Create a copy of [settings.xml](settings.xml) and save it to `~/.m2/settings.xml`
9. Update the variables in your `~/.m2/settings.xml` with the token value and target usdot-jpo-ode organization. Here is an example filled in `settings.xml` file:

```XML
<?xml version="1.0" encoding="UTF-8"?>
<settings>
    <activeProfiles>
        <activeProfile>default</activeProfile>
    </activeProfiles>
    <servers>
        <server>
            <id>github</id>
            <username>cvmanager_intersection_api</username>
            <password>**github_token**</password>
        </server>
    ... apply same to other servers
    </servers>
    <profiles>
        <profile>
            <id>default</id>
            <repositories>
                <repository>
                    <id>github</id>
                    <name>GitHub Apache Maven Packages</name>
                    <url>https://maven.pkg.github.com/usdot-jpo-ode/jpo-ode</url>
                    <snapshots>
                        <enabled>false</enabled>
                    </snapshots>
                </repository>
                ... apply same to other repositories
            </repositories>
        </profile>
    </profiles>
</settings>
```

### Create an application-dev.yaml

1. Navigate to the `src/main/resources` directory:

   ```sh
   cd src/main/resources
   ```

2. Copy the contents of the `application.yaml` file to a new file named `application-dev.yaml`:

   ```sh
   cp application.yaml application-dev.yaml
   ```

3. Replace all environment variable references in `application-dev.yaml` with your local variables (usually copied from the project root .env file).

### Project Updates

If running alongside the rest of the cv-manager, please make the following updates to your root .env file:

1. Use the intersection_no_api docker profile
   If intending to start the mongodb and kafka services through docker, use the `intersection_no_api` profile, instead of the `intersection` profile. This is exactly the same, but allows the API to be run locally instead of through docker. This is updated through the COMPOSE_PROFILES environment variable, like so:

```
COMPOSE_PROFILES=basic,webapp,intersection_no_api
```

2. If using alongside the webapp, update the following Webapp env variables:

```
CVIZ_API_SERVER_URL=http://localhost:8089
CVIZ_API_WS_URL=ws://localhost:8089
```

### Run the application

Install and run the intersection API using the following commands:

1. **Clean and install the project**:

   ```sh
   mvn clean install
   ```

2. **Run the application with the `dev` profile**:

   ```sh
   mvn -Dspring-boot:run.profiles=dev spring-boot:run
   ```

## Running Tests

To run unit tests, run the following command (ensure docker engine is running):

```sh
mvn test
```

It may be useful to run tests with the dev profile (using resources/application-dev.yaml)

```sh
$env:SPRING_PROFILES_ACTIVE="dev"
```

### Unit Test Coverage

To generate unit test coverage run:

```sh
mvn clean verify
```

Then open the following file in a browser: [index.html](./target/site/jacoco/index.html)

## Swagger API

The Intersection API utilizes swagger for viewing and testing api endpoints. The Swagger endpoint can be accessed here:
http://localhost:8088/swagger-ui/index.html

To facilitate easy development of front-end applications, the Intersection API is equipped with the capability to provide testData from each of its endpoints. To retrieve test data, set the url param testData to True when making the request.
